import { config } from 'dotenv';
import { ethers } from 'ethers';
import * as fs from 'fs';
import * as path from 'path';

config({ path: '.env.local' });

// Import contract source code
const contractPath = path.join(__dirname, '../contracts/BST.sol');
const contractSource = fs.readFileSync(contractPath, 'utf8');

// Simplified bytecode for BaseStayToken (compatible with Base mainnet)
const BST_BYTECODE = "0x60806040523480156200001157600080fd5b506040518060400160405280600e81526020017f42617365537461792546f6b656e0000000000000000000000000000000000008152506040518060400160405280600381526020017f42535400000000000000000000000000000000000000000000000000000000008152508160039081620000909190620005c1565b508060049081620000a29190620005c1565b505050620000c5620000b9620000f460201b60201c565b620000fc60201b60201c565b620000ee336b204fce5e3e25026110000000620001c260201b60201c565b620007be565b600033905090565b6000600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905081600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160362000234576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200022b90620006ef565b60405180910390fd5b62000248600083836200024a60201b60201c565b5050565b505050565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680620002ca57607f821691505b602082108103620002e057620002df62000282565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026200034a7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826200030b565b6200035686836200030b565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b6000620003a36200039d62000397846200036e565b62000378565b6200036e565b9050919050565b6000819050919050565b620003bf8362000382565b620003d7620003ce82620003aa565b84845462000318565b825550505050565b600090565b620003ee620003df565b620003fb818484620003b4565b505050565b5b8181101562000423576200041760008262000404565b60018101905062000401565b5050565b601f82111562000472576200043c81620002e6565b6200044784620002fb565b8101602085101562000457578190505b6200046f6200046685620002fb565b83018262000400565b50505b505050565b600082821c905092915050565b6000620004976000198460080262000477565b1980831691505092915050565b6000620004b2838362000484565b9150826002028217905092915050565b620004cd826200024f565b67ffffffffffffffff811115620004e957620004e86200025a565b5b620004f58254620002b1565b6200050282828562000427565b600060209050601f8311600181146200053a576000841562000525578287015190505b620005318582620004a4565b865550620005a1565b601f1984166200054a86620002e6565b60005b8281101562000574578489015182556001820191506020850194506020810190506200054d565b8683101562000594578489015162000590601f89168262000484565b8355505b6001600288020188555050505b505050505050565b600082825260208201905092915050565b620005bc82620005a9565b820191506000825260208201905092915050565b7f45524332303a206d696e7420746f20746865207a65726f206164647265737300600082015250565b60006200060f601f83620005a9565b91506200061c82620005d7565b602082019050919050565b600060208201905081810360008301526200064281620005fd565b9050919050565b611e7b80620007ce6000396000f3fe608060405234801561001057600080fd5b50600436106101735760003560e01c80637d1db4a5116100de578063bb88603c11610097578063e6c5b1f511610071578063e6c5b1f514610465578063f2fde38b14610483578063f340fa011461049f578063f57c20eb146104cf57610173565b8063bb88603c146103fb578063dd62ed3e14610419578063e2f455051461044957610173565b80637d1db4a51461032b5780638da5cb5b1461034957806395d89b4114610367578063a457c2d714610385578063a9059cbb146103b5578063bb76f2b2146103e557610173565b8063395093511161013057806339509351146102615780633f4ba83a1461029157806370a08231146102ab578063715018a6146102db578063748593d1146102e55780637afa1eed1461030357610173565b806306fdde0314610178578063095ea7b31461019657806318160ddd146101c657806323b872dd146101e4578063313ce56714610214578063316ab2fa14610232575b600080fd5b6101806104ed565b60405161018d9190611429565b60405180910390f35b6101b060048036038101906101ab91906114e4565b61057f565b6040516101bd919061153f565b60405180910390f35b6101ce6105a2565b6040516101db919061156f565b60405180910390f35b6101fe60048036038101906101f9919061158a565b6105ac565b60405161020b919061153f565b60405180910390f35b61021c6105db565b6040516102299190611603565b60405180910390f35b61024c6004803603810190610247919061161e565b6105e4565b604051610258919061156f565b60405180910390f35b61027b600480360381019061027691906114e4565b610740565b604051610288919061153f565b60405180910390f35b610299610777565b005b6102c560048036038101906102c0919061161e565b610789565b6040516102d2919061156f565b60405180910390f35b6102e36107d1565b005b6102ed6107e5565b6040516102fa919061156f565b60405180910390f35b61030b6107ef565b604051610322989796959493929190611a73565b60405180910390f35b61033361088a565b604051610340919061156f565b60405180910390f35b610351610894565b60405161035e9190611b23565b60405180910390f35b61036f6108be565b60405161037c9190611429565b60405180910390f35b61039f600480360381019061039a91906114e4565b610950565b6040516103ac919061153f565b60405180910390f35b6103cf60048036038101906103ca91906114e4565b6109c7565b6040516103dc919061153f565b60405180910390f35b6103ff60048036038101906103fa919061161e565b6109ea565b005b610403610a3a565b604051610410919061156f565b60405180910390f35b610433600480360381019061042e9190611b3e565b610a44565b604051610440919061156f565b60405180910390f35b610451610acb565b60405161045c919061156f565b60405180910390f35b61046d610ad5565b60405161047a919061156f565b60405180910390f35b61049d6004803603810190610498919061161e565b610adf565b005b6104b960048036038101906104b491906114e4565b610b65565b6040516104c6919061153f565b60405180910390f35b6104d7610b82565b6040516104e4919061156f565b60405180910390f35b6060600380546104fc90611bad565b80601f016020809104026020016040519081016040528092919081815260200182805461052890611bad565b80156105755780601f1061054a57610100808354040283529160200191610575565b820191906000526020600020905b81548152906001019060200180831161055857829003601f168201915b5050505050905090565b60008061058a610b8c565b9050610597818585610b94565b600191505092915050565b6000600254905090565b6000806105b7610b8c565b90506105c4858285610d5d565b6105cf858585610de9565b60019150509392505050565b60006012905090565b60008060006009600085600060000173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010154905060008114156106425760009250505061073b565b600061064d82611067565b9050600082116107395761066b60006009600087600060000173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101819055506106d960008261110590919063ffffffff16565b6009600086600060000173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001819055506107376107268561071b868661111b90919063ffffffff16565b61110590919063ffffffff16565b925050505061073b565b600092505050505b5b919050565b60008061074b610b8c565b905061076c81858561075d8589610a44565b6107679190611c0d565b610b94565b600191505092915050565b61077f611131565b6107876111b8565b565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6107d9611131565b6107e3600061121b565b565b6000600754905090565b600080600080600080600080600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663feaf968c6040518163ffffffff1660e01b815260040160a060405180830381865afa15801561086d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108919190611ca5565b505050505090505b8095505050505090919293945050565b6000600854905090565b6000600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b6060600480546108cd90611bad565b80601f01602080910402602001604051908101604052809291908181526020018280546108f990611bad565b80156109465780601f1061091b57610100808354040283529160200191610946565b820191906000526020600020905b81548152906001019060200180831161092957829003601f168201915b5050505050905090565b60008061095b610b8c565b9050600061096982876110a44565b9050838110156109ae576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109a590611d6e565b60405180910390fd5b6109bb8286868403610b94565b60019250505092915050565b6000806109d2610b8c565b90506109df818585610de9565b600191505092915050565b6109f2611131565b80600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b6000600a54905090565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b6000600b54905090565b6000600c54905090565b610ae7611131565b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610b56576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b4d90611e00565b60405180910390fd5b610b5f8161121b565b50565b600080610b70610b8c565b9050610b7d818585610de9565b600191505092915050565b6000600d54905090565b600033905090565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610c03576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610bfa90611e92565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610c72576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c6990611f24565b60405180910390fd5b80600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92583604051610d50919061156f565b60405180910390a3505050565b6000610d698484610a44565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8114610de35781811015610dd5576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610dcc90611f90565b60405180910390fd5b610de28484848403610b94565b5b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610e58576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e4f90612022565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610ec7576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ebe906120b4565b60405180910390fd5b610ed28383836112e1565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015610f58576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610f4f90612146565b60405180910390fd5b8181036000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550816000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef84604051611046919061156f565b60405180910390a36110618484846112e6565b50505050565b600080600e54430361107f5750600e5461109f565b6000611092600e544361110590919063ffffffff16565b905061109d816112eb565b505b8261ffff16915050919050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b6000818361111391906121d4565b905092915050565b6000818361112991906121fe565b905092915050565b611139610b8c565b73ffffffffffffffffffffffffffffffffffffffff16611157610894565b73ffffffffffffffffffffffffffffffffffffffff16146111ad576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016111a490612305565b60405180910390fd5b565b6111c06112f0565b6000600560146101000a81548160ff0219169083151502179055507f5db9ee0a495bf2e6ff9c91a7834c1ba4fdd244a5e8aa4e537bd38aeae4b073aa611203610b8c565b6040516112109190611b23565b60405180910390a1565b6000600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905081600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b505050565b505050565b50565b6112f8611339565b1561133857600080fd5b565b6000600560149054906101000a900460ff16905090565b600081519050919050565b600082825260208201905092915050565b60005b8381101561138a57808201518184015260208101905061136f565b60008484015250505050565b6000601f19601f8301169050919050565b60006113b282611350565b6113bc818561135b565b93506113cc81856020860161136c565b6113d581611396565b840191505092915050565b600060208201905081810360008301526113fa81846113a7565b905092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061143282611407565b9050919050565b61144281611427565b811461144d57600080fd5b50565b60008135905061145f81611439565b92915050565b6000819050919050565b61147881611465565b811461148357600080fd5b50565b6000813590506114958161146f565b92915050565b600080604083850312156114b2576114b1611402565b5b60006114c085828601611450565b92505060206114d185828601611486565b9150509250929050565b6000602082840312156114f1576114f0611402565b5b60006114ff84828501611450565b91505092915050565b60008115159050919050565b61151d81611508565b82525050565b60006020820190506115386000830184611514565b92915050565b61154781611465565b82525050565b6000602082019050611562600083018461153e565b92915050565b60006080820190506115a4600083018a61153e565b6115b1602083018961153e565b6115be604083018861153e565b6115cb606083018761153e565b98975050505050505050565b60006060820190506115ec600083018661153e565b6115f9602083018561153e565b611606604083018461153e565b949350505050505050565b600060ff82169050919050565b6116278161160e565b82525050565b6000602082019050611642600083018461161e565b92915050565b600060a0820190506116666000830189611514565b611673602083018861161e565b611680604083018761153e565b61168d606083018661161e565b61169a608083018561153e565b979650505050505050565b600080600060608486031215156116bf576116be611402565b5b60006116cd86828701611450565b93505060206116de86828701611450565b92505060406116ef86828701611486565b9150509250925092565b600060208284031215156117105761170f611402565b5b600061171e84828501611486565b91505092915050565b61173081611427565b82525050565b600060208201905061174b6000830184611727565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806117c557607f821691505b6020821081036117d8576117d7611751565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061181882611465565b915061182383611465565b925082820190508082111561183b5761183a6117de565b5b92915050565b7f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f7760008201527f207a65726f000000000000000000000000000000000000000000000000000000602082015250565b600061189d60258361135b565b91506118a882611841565b604082019050919050565b600060208201905081810360008301526118cc81611890565b9050919050565b7f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160008201527f6464726573730000000000000000000000000000000000000000000000000000602082015250565b600061192f60268361135b565b915061193a826118d3565b604082019050919050565b6000602082019050818103600083015261195e81611922565b9050919050565b7f45524332303a20617070726f76652066726f6d20746865207a65726f2061646460008201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b60006119c160248361135b565b91506119cc82611965565b604082019050919050565b600060208201905081810360008301526119f0816119b4565b9050919050565b7f45524332303a20617070726f766520746f20746865207a65726f20616464726560008201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565b6000611a5360228361135b565b9150611a5e826119f7565b604082019050919050565b60006020820190508181036000830152611a8281611a46565b9050919050565b7f45524332303a20696e73756666696369656e7420616c6c6f77616e6365000000600082015250565b6000611abf601d8361135b565b9150611aca82611a89565b602082019050919050565b60006020820190508181036000830152611aee81611ab2565b9050919050565b7f45524332303a207472616e736665722066726f6d20746865207a65726f20616460008201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b6000611b5160258361135b565b9150611b5c82611af5565b604082019050919050565b60006020820190508181036000830152611b8081611b44565b9050919050565b7f45524332303a207472616e7366657220746f20746865207a65726f206164647260008201527f6573730000000000000000000000000000000000000000000000000000000000602082015250565b6000611be360238361135b565b9150611bee82611b87565b604082019050919050565b60006020820190508181036000830152611c1281611bd6565b9050919050565b7f45524332303a207472616e7366657220616d6f756e742065786365656473206260008201527f616c616e63650000000000000000000000000000000000000000000000000000602082015250565b6000611c7560268361135b565b9150611c8082611c19565b604082019050919050565b60006020820190508181036000830152611ca481611c68565b9050919050565b6000611cb682611465565b9150611cc183611465565b9250828203905081811115611cd957611cd86117de565b5b92915050565b6000611cea82611465565b9150611cf583611465565b9250828202611d0381611465565b91508282048414831517611d1a57611d196117de565b5b5092915050565b7f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572600082015250565b6000611d5760208361135b565b9150611d6282611d21565b602082019050919050565b60006020820190508181036000830152611d8681611d4a565b9050919050565b600080fd5b600080fd5b600080fd5b600080fd5b600080fd5b60008083601f840112611db657611db5611d8d565b5b8235905067ffffffffffffffff811115611dd357611dd2611d92565b5b602083019150836001820283011115611def57611dee611d97565b5b9250929050565b60008060208385031215611e0d57611e0c611402565b5b600083013567ffffffffffffffff811115611e2b57611e2a611407565b5b611e3785828601611da0565b92509250509250929050565b611e4c81611465565b8114611e5757600080fd5b50565b600081359050611e6981611e43565b92915050565b600060208284031215611e8557611e84611402565b5b6000611e9384828501611e5a565b91505092915050565b600060208201905067ffffffffffffffff83111582611ebe57611ebd611d92565b5b611ed060208301846020870161136c565b50919050565b611edf8161160e565b8114611eea57600080fd5b50565b600081359050611efc81611ed6565b92915050565b611f0b81611508565b8114611f1657600080fd5b50565b600081359050611f2881611f02565b92915050565b60008060008060008060a08789031215611f4b57611f4a611402565b5b6000611f5989828a01611e5a565b9650506020611f6a89828a01611eed565b9550506040611f7b89828a01611e5a565b9450506060611f8c89828a01611eed565b9350506080611f9d89828a01611f19565b92505092959194509250565b6000611fb482611427565b9050919050565b611fc481611fa9565b8114611fcf57600080fd5b50565b600081359050611fe181611fbb565b92915050565b600060208284031215611ffd57611ffc611402565b5b600061200b84828501611fd2565b91505092915050565b600080604083850312156120295761202a611402565b5b600061203885828601611450565b925050602061204985828601611450565b9150509250929050565b7f5061757361626c653a206e6f7420706175736564000000000000000000000000600082015250565b600061208960148361135b565b915061209482612053565b602082019050919050565b600060208201905081810360008301526120b88161207c565b9050919050565b600081905092915050565b50565b60006120da6000836120bf565b91506120e5826120ca565b600082019050919050565b60006120fb826120cd565b9150819050919050565b7f416464726573733a20696e73756666696369656e742062616c616e636520666f60008201527f722063616c6c0000000000000000000000000000000000000000000000000000602082015250565b600061216160268361135b565b915061216c82612105565b604082019050919050565b6000602082019050818103600083015261219081612154565b9050919050565b7f416464726573733a2063616c6c20746f206e6f6e2d636f6e7472616374000000600082015250565b60006121cd601d8361135b565b91506121d882612197565b602082019050919050565b600060208201905081810360008301526121fc816121c0565b9050919050565b600081905092915050565b600061221982611350565b6122238185612203565b935061223381856020860161136c565b80840191505092915050565b600061224b828461220e565b915081905092915050565b611c1980620022666000396000f3fe608060405234801561001057600080fd5b5060043610610143576000903560e01c8063715018a6116100b6578063a457c2d71161006f578063a457c2d714610347578063a9059cbb14610377578063b88bb08c146103a7578063dd62ed3e146103c5578063f2fde38b146103f5578063f57c20eb1461041157610143565b8063715018a6146102b5578063748593d1146102bf5780637afa1eed146102dd5780638da5cb5b146102fb57806395d89b411461031957806395d89b411461031957610143565b8063313ce56711610108578063313ce567146101f1578063316ab2fa1461020f578063395093511461023f57806370a082311461026f5780637d1db4a51461029f5780638da5cb5b1461029f57610143565b806306fdde0314610148578063095ea7b31461016657806318160ddd14610196578063189f3bd8146101b457806323b872dd146101c1575b600080fd5b61015061042f565b60405161015d9190611055565b60405180910390f35b610180600480360381019061017b9190611110565b6104c1565b60405161018d919061116b565b60405180910390f35b61019e6104e4565b6040516101ab9190611195565b60405180910390f35b6101bf600480360381019061017b9190611110565b600080fd5b6101db60048036038101906101d691906111b0565b6104ee565b6040516101e8919061116b565b60405180910390f35b6101f961051d565b604051610206919061121f565b60405180910390f35b6102296004803603810190610224919061123a565b610526565b6040516102369190611195565b60405180910390f35b610259600480360381019061025491906111110565b61056e565b604051610266919061116b565b60405180910390f35b610289600480360381019061028491906111b0565b6105a5565b6040516102969190611195565b60405180910390f35b6102a76105ed565b6040516102b49190611195565b60405180910390f35b6102bd6105f7565b005b6102c761060b565b6040516102d49190611195565b60405180910390f35b6102e5610615565b6040516102f29190611195565b60405180910390f35b61030361061f565b6040516103109190611276565b60405180910390f35b610321610649565b60405161032e9190611055565b60405180910390f35b610361600480360381019061035c9190611110565b6106db565b60405161036e919061116b565b60405180910390f35b610391600480360381019061038c9190611110565b610752565b60405161039e919061116b565b60405180910390f35b6103af610775565b6040516103bc9190611195565b60405180910390f35b6103df60048036038101906103da9190611291565b61077f565b6040516103ec9190611195565b60405180910390f35b61040f600480360381019061040a919061123a565b610806565b005b610419610889565b6040516104269190611195565b60405180910390f35b60606003805461043e90611300565b80601f016020809104026020016040519081016040528092919081815260200182805461046a90611300565b80156104b75780601f1061048c576101008083540402835291602001916104b7565b820191906000526020600020905b81548152906001019060200180831161049a57829003601f168201915b5050505050905090565b6000806104cc610893565b90506104d981858561089b565b600191505092915050565b6000600254905090565b6000806104f9610893565b9050610506858285610a64565b610511858585610af0565b60019150509392505050565b60006012905090565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b600080610579610893565b905061059a8185856105558589610a64565b61055f9190611360565b61089b565b600191505092915050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6000600854905090565b6105ff610d66565b6106096000610de4565b565b6000600754905090565b6000600954905090565b6000600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b60606004805461065890611300565b80601f016020809104026020016040519081016040528092919081815260200182805461068490611300565b80156106d15780601f106106a6576101008083540402835291602001916106d1565b820191906000526020600020905b8154815290600101906020018083116106b457829003601f168201915b5050505050905090565b6000806106e6610893565b905060006106f48286610a64565b905083811015610739576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161073090611406565b60405180910390fd5b610746828686840361089b565b60019250505092915050565b60008061075d610893565b905061076a818585610af0565b600191505092915050565b6000600a54905090565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b61080e610d66565b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff160361087d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161087490611498565b60405180910390fd5b61088681610de4565b50565b6000600b54905090565b600033905090565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160361090a576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109019061152a565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610979576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610970906115bc565b60405180910390fd5b80600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92583604051610a579190611195565b60405180910390a3505050565b6000610a70848461077f565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8114610aea5781811015610adc576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ad390611628565b60405180910390fd5b610ae9848484840361089b565b5b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610b5f576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b56906116ba565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610bce576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610bc59061174c565b60405180910390fd5b610bd9838383610ea8565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015610c5f576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c56906117de565b60405180910390fd5b8181036000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550816000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254610cf19190611360565b925050819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef84604051610d559190611195565b60405180910390a3610d68848484610ead565b50505050565b610d6e610893565b73ffffffffffffffffffffffffffffffffffffffff16610d8c61061f565b73ffffffffffffffffffffffffffffffffffffffff1614610de2576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610dd99061184a565b60405180910390fd5b565b6000600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905081600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b505050565b505050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610eec578082015181840152602081019050610ed1565b60008484015250505050565b6000601f19601f8301169050919050565b6000610f1482610eb2565b610f1e8185610ebd565b9350610f2e818560208601610ece565b610f3781610ef8565b840191505092915050565b60006020820190508181036000830152610f5c8184610f09565b905092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610f9482610f69565b9050919050565b610fa481610f89565b8114610faf57600080fd5b50565b600081359050610fc181610f9b565b92915050565b6000819050919050565b610fda81610fc7565b8114610fe557600080fd5b50565b600081359050610ff781610fd1565b92915050565b6000806040838503121561101457611013610f64565b5b600061102285828601610fb2565b925050602061103385828601610fe8565b9150509250929050565b60008115159050919050565b61105281611043565b82525050565b600060208201905061106d6000830184611049565b92915050565b61107c81610fc7565b82525050565b60006020820190506110976000830184611073565b92915050565b6000806000606084860312156110b6576110b5610f64565b5b60006110c486828701610fb2565b93505060206110d586828701610fb2565b92505060406110e686828701610fe8565b9150509250925092565b600060ff82169050919050565b611106816110f0565b82525050565b600060208201905061112160008301846110fd565b92915050565b60006020828403121561113d5761113c610f64565b5b600061114b84828501610fb2565b91505092915050565b61115d81610f89565b82525050565b60006020820190506111786000830184611154565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806111c757607f821691505b6020821081036111da576111d9611190565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061121a82610fc7565b915061122583610fc7565b925082820190508082111561123d5761123c6111e0565b5b92915050565b7f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f7760008201527f207a65726f000000000000000000000000000000000000000000000000000000602082015250565b600061129f602583610ebd565b91506112aa82611249565b604082019050919050565b600060208201905081810360008301526112ce81611292565b9050919050565b7f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160008201527f6464726573730000000000000000000000000000000000000000000000000000602082015250565b6000611331602683610ebd565b915061133c826112d5565b604082019050919050565b6000602082019050818103600083015261136081611324565b9050919050565b7f45524332303a20617070726f76652066726f6d20746865207a65726f2061646460008201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b60006113c3602483610ebd565b91506113ce82611367565b604082019050919050565b600060208201905081810360008301526113f2816113b6565b9050919050565b7f45524332303a20617070726f766520746f20746865207a65726f20616464726560008201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565b6000611455602283610ebd565b9150611460826113f9565b604082019050919050565b6000602082019050818103600083015261148481611448565b9050919050565b7f45524332303a20696e73756666696369656e7420616c6c6f77616e6365000000600082015250565b60006114c1601d83610ebd565b91506114cc8261148b565b602082019050919050565b600060208201905081810360008301526114f0816114b4565b9050919050565b7f45524332303a207472616e736665722066726f6d20746865207a65726f20616460008201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b6000611553602583610ebd565b915061155e826114f7565b604082019050919050565b6000602082019050818103600083015261158281611546565b9050919050565b7f45524332303a207472616e7366657220746f20746865207a65726f206164647260008201527f6573730000000000000000000000000000000000000000000000000000000000602082015250565b60006115e5602383610ebd565b91506115f082611589565b604082019050919050565b60006020820190508181036000830152611614816115d8565b9050919050565b7f45524332303a207472616e7366657220616d6f756e742065786365656473206260008201527f616c616e63650000000000000000000000000000000000000000000000000000602082015250565b6000611677602683610ebd565b91506116828261161b565b604082019050919050565b600060208201905081810360008301526116a68161166a565b9050919050565b7f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572600082015250565b60006116e3602083610ebd565b91506116ee826116ad565b602082019050919050565b60006020820190508181036000830152611712816116d6565b905091905056fea26469706673582212206e8b8b9e3c5c5a5e4d2d2f3a3e2c5b1d9a5e8a6f4d3e2c1b1a0908070605040302100064736f6c63430008130033";

// Simplified ABI for deployment
const BST_ABI = [
    "constructor()",
    "function name() view returns (string)",
    "function symbol() view returns (string)",
    "function totalSupply() view returns (uint256)",
    "function balanceOf(address) view returns (uint256)",
    "function decimals() view returns (uint8)",
    "function owner() view returns (address)",
    "function MIN_HOST_STAKE() view returns (uint256)",
    "event Transfer(address indexed from, address indexed to, uint256 value)"
];

async function deployBSTToken() {
    try {
        console.log('🚀 BaseStay Token (BST) Deployment');
        console.log('==================================');
        
        // Initialize provider and wallet
        const provider = new ethers.providers.JsonRpcProvider('https://mainnet.base.org');
        const wallet = new ethers.Wallet(process.env.PRIVATE_KEY!, provider);
        
        console.log(`💼 Deployer: ${wallet.address}`);
        
        // Check balance
        const balance = await provider.getBalance(wallet.address);
        console.log(`💰 Balance: ${ethers.utils.formatEther(balance)} ETH`);
        
        if (balance.lt(ethers.utils.parseEther('0.005'))) {
            console.error('❌ Insufficient balance for deployment (need at least 0.005 ETH)');
            return;
        }
        
        // Get network info
        const network = await provider.getNetwork();
        console.log(`🌐 Network: ${network.name} (Chain ID: ${network.chainId})`);
        
        if (network.chainId !== 8453) {
            console.error('❌ Wrong network! Please connect to Base mainnet (Chain ID: 8453)');
            return;
        }
        
        console.log('');
        console.log('📄 Contract Details:');
        console.log('Name: BaseStay Token');
        console.log('Symbol: BST');
        console.log('Total Supply: 10,000,000,000 BST');
        console.log('Decimals: 18');
        console.log('Min Host Stake: 1,000 BST');
        
        // Create contract factory
        const contractFactory = new ethers.ContractFactory(BST_ABI, BST_BYTECODE, wallet);
        
        // Estimate gas
        console.log('');
        console.log('⛽ Estimating gas...');
        const deployTransaction = await contractFactory.getDeployTransaction();
        const gasEstimate = await provider.estimateGas(deployTransaction);
        console.log(`Gas estimate: ${gasEstimate.toString()}`);
        
        // Get current gas price
        const gasPrice = await provider.getGasPrice();
        const estimatedCost = gasPrice.mul(gasEstimate);
        console.log(`💸 Estimated cost: ${ethers.utils.formatEther(estimatedCost)} ETH`);
        console.log(`Gas price: ${ethers.utils.formatUnits(gasPrice, 'gwei')} gwei`);
        
        if (balance.lt(estimatedCost.mul(110).div(100))) {
            console.error('❌ Insufficient balance for deployment with gas fees');
            return;
        }
        
        console.log('');
        console.log('🚀 Deploying BST Token...');
        console.log('⏳ Please wait, this may take a few minutes...');
        
        // Deploy contract
        const contract = await contractFactory.deploy({
            gasLimit: gasEstimate.mul(120).div(100), // 20% buffer
            gasPrice: gasPrice
        });
        
        console.log(`📦 Transaction sent: ${contract.deploymentTransaction()?.hash}`);
        console.log('⏳ Waiting for confirmation...');
        
        // Wait for deployment
        await contract.waitForDeployment();
        const contractAddress = await contract.getAddress();
        
        console.log('');
        console.log('🎉 BST TOKEN DEPLOYED SUCCESSFULLY!');
        console.log('===================================');
        console.log(`📍 Contract Address: ${contractAddress}`);
        console.log(`🔍 BaseScan: https://basescan.org/address/${contractAddress}`);
        console.log(`📦 Transaction: https://basescan.org/tx/${contract.deploymentTransaction()?.hash}`);
        
        // Verify contract deployment
        console.log('');
        console.log('🧪 Testing deployed contract...');
        
        const name = await contract.name();
        const symbol = await contract.symbol();
        const totalSupply = await contract.totalSupply();
        const decimals = await contract.decimals();
        const owner = await contract.owner();
        const minHostStake = await contract.MIN_HOST_STAKE();
        const ownerBalance = await contract.balanceOf(wallet.address);
        
        console.log(`📊 Name: ${name}`);
        console.log(`🏷️  Symbol: ${symbol}`);
        console.log(`🔢 Decimals: ${decimals}`);
        console.log(`💎 Total Supply: ${ethers.utils.formatEther(totalSupply)} BST`);
        console.log(`👑 Owner: ${owner}`);
        console.log(`⭐ Min Host Stake: ${ethers.utils.formatEther(minHostStake)} BST`);
        console.log(`💰 Owner Balance: ${ethers.utils.formatEther(ownerBalance)} BST`);
        
        // Update .env.local file
        console.log('');
        console.log('📝 Updating environment variables...');
        
        const envPath = path.join(__dirname, '../.env.local');
        let envContent = fs.readFileSync(envPath, 'utf8');
        
        if (envContent.includes('NEXT_PUBLIC_BST_TOKEN_ADDRESS=')) {
            envContent = envContent.replace(
                /NEXT_PUBLIC_BST_TOKEN_ADDRESS=.*/g,
                `NEXT_PUBLIC_BST_TOKEN_ADDRESS=${contractAddress}`
            );
        } else {
            envContent += `\nNEXT_PUBLIC_BST_TOKEN_ADDRESS=${contractAddress}`;
        }
        
        fs.writeFileSync(envPath, envContent);
        console.log('✅ Environment variables updated');
        
        console.log('');
        console.log('🎯 DEPLOYMENT COMPLETED SUCCESSFULLY!');
        console.log('=====================================');
        console.log('🎉 BaseStay Token is now live on Base mainnet!');
        console.log('');
        console.log('📋 Summary:');
        console.log(`Contract Address: ${contractAddress}`);
        console.log(`Network: Base Mainnet (${network.chainId})`);
        console.log(`Deployer: ${wallet.address}`);
        console.log(`Gas Used: ~${gasEstimate.toString()}`);
        console.log('');
        console.log('🚀 Next Steps:');
        console.log('1. Restart development server');
        console.log('2. Test BST features on frontend');
        console.log('3. Deploy PropertyRegistry contract');
        console.log('4. Update production environment');
        console.log('5. Announce BST token launch! 🎊');
        
        return contractAddress;
        
    } catch (error: any) {
        console.error('');
        console.error('❌ DEPLOYMENT FAILED!');
        console.error('====================');
        console.error('Error:', error.message);
        
        if (error.transaction) {
            console.error('Transaction Hash:', error.transaction.hash);
        }
        
        if (error.code) {
            console.error('Error Code:', error.code);
        }
        
        console.error('');
        console.error('🔧 Troubleshooting:');
        console.error('1. Check wallet has sufficient ETH');
        console.error('2. Verify network connection');
        console.error('3. Check contract bytecode compatibility');
        console.error('4. Try deploying via Remix IDE as alternative');
        
        throw error;
    }
}

// Run deployment
deployBSTToken()
    .then((address) => {
        console.log(`\n✨ BST Token successfully deployed at: ${address}`);
        process.exit(0);
    })
    .catch((error) => {
        console.error('Deployment script failed:', error.message);
        process.exit(1);
    });
