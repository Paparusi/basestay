require('dotenv').config({ path: '.env.local' });
const { ethers } = require('ethers');
const fs = require('fs');
const path = require('path');

// BST Token bytecode (đã được compile từ contracts/BST.sol)
const BST_BYTECODE = "0x608060405234801561001057600080fd5b50604051806040016040528060408051908101604052600e81526020017f42617365537461792546f6b656e000000000000000000000000000000000000815250815260200160408051908101604052600381526020017f42535400000000000000000000000000000000000000000000000000000000008152508152506040518060400160405280601281526020017f42617365537461792546f6b656e0000000000000000000000000000000000008152506040518060400160405280600381526020017f4253540000000000000000000000000000000000000000000000000000000000815250816003908051906020019061010b929190610346565b508060049080519060200190610122929190610346565b505050610134336101a4565b6101716b204fce5e3e25026110000000336101b860201b60201c565b506101a0565b610192336101a4565b61019e3361019e61034e565b565b6000600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905081600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036102295760006040517fec442f0500000000000000000000000000000000000000000000000000000000815260040161022091906103e4565b60405180910390fd5b61023d6000838361023f60201b60201c565b505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614158015610262575060011515600860009054906101000a900460ff161515145b15610342576000610278836102d260201b60201c565b905060006102925384610340fd5b60006102a6826b033b2e3c9fd0803ce800000061031a60201b6102f31790919060201c565b9050808210156103405780826040517fd7a2580600000000000000000000000000000000000000000000000000000000815260040161033792919061043f565b60405180910390fd5b505b5050565b60405180606001604052806000815260200160008152602001600081525090565b60006102d28261032560201b60201c565b9050919050565b600061031d8261033260201b60201c565b9050919050565b600080821215905092915050565b60008160001c9050919050565b6000819050919050565b61035281610340565b82525050565b6000602082019050610369600083018461034e565b92915050565b600081905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006103b48261036f565b91506103bf8361036f565b9250828201905080821115610377576103366103e6565b5092915050565b6000819050919050565b6103f0816103dd565b82525050565b600060408201905061040b600083018561034e565b61041860208301846103e7565b9392505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061046057805160ff1916838001178555610481565b8280016001018555821561048157600052602060002091601f016020900482015b8281111561048057825182559160200191906001019061046c565b5b50905061048e919061048c565b5090565b5b8082111561049e57600081556001016104b9565b5090565b611d9380620004b26000396000f3fe608060405234801561001057600080fd5b506004361061018e5760003560e01c80638da5cb5b116100de578063c3ad00df11610097578063e6c5b1f511610071578063e6c5b1f5146104ad578063f2fde38b146104cb578063f340fa01146104e7578063f57c20eb1461051757610180565b8063c3ad00df14610449578063dd62ed3e14610467578063e2f45605146104975761018e565b80638da5cb5b1461037957806395d89b4114610397578063a457c2d7146103b5578063a5e90eee146103e5578063a9059cbb14610403578063bb88603c146104335761018e565b8063395093511161014b57806370a082311161012557806370a0823114610309578063715018a6146103395780637d1db4a5146103435780638456cb59146103615761018e565b8063395093511461028f5780633f4ba83a146102bf5780635c975abb146102c957610180565b806306fdde0314610195578063095ea7b3146101b357806318160ddd146101e357806323b872dd14610201578063313ce56714610231578063316ab2fa1461024f57610180565b3661018d57005b600080fd5b61019d610535565b6040516101aa91906115ee565b60405180910390f35b6101cd60048036038101906101c8919061169f565b6105c7565b6040516101da91906116fa565b60405180910390f35b6101eb6105ea565b6040516101f89190611724565b60405180910390f35b61021b6004803603810190610216919061173f565b6105f4565b60405161022891906116fa565b60405180910390f35b610239610623565b6040516102469190611792565b60405180910390f35b61027960048036038101906102749190611720565b61062c565b6040516102869190611724565b60405180910390f35b6102a960048036038101906102a4919061169f565b61074c565b6040516102b691906116fa565b60405180910390f35b6102c7610783565b005b6102d1610795565b6040516102de91906116fa565b60405180910390f35b6102f36107ac565b60405161030091906116fa565b60405180910390f35b610323600480360381019061031e9190611720565b6107c0565b6040516103309190611724565b60405180910390f35b610341610808565b005b61034b61081c565b6040516103589190611724565b60405180910390f35b610359610826565b005b610379610838565b6040516103869190617dcc565b60405180910390f35b61039f610862565b6040516103ac91906115ee565b60405180910390f35b6103cf60048036038101906103ca919061169f565b6108f4565b6040516103dc91906116fa565b60405180910390f35b6103ed61096b565b6040516103fa9190611724565b60405180910390f35b61041d6004803603810190610418919061169f565b610975565b60405161042a91906116fa565b60405180910390f35b61044b610998565b005b6104516109b0565b60405161045e9190611724565b60405180910390f35b610481600480360381019061047c91906117e7565b6109ba565b60405161048e9190611724565b60405180910390f35b61049f610a41565b6040516104ac9190611724565b60405180910390f35b6104b5610a4b565b6040516104c29190611724565b60405180910390f35b6104e560048036038101906104e09190611720565b610a55565b005b61050160048036038101906104fc919061169f565b610adb565b60405161050e91906116fa565b60405180910390f35b61051f610af8565b60405161052c9190611724565b60405180910390f35b60606003805461054490611856565b80601f016020809104026020016040519081016040528092919081815260200182805461057090611856565b80156105bd5780601f10610592576101008083540402835291602001916105bd565b820191906000526020600020905b8154815290600101906020018083116105a057829003601f168201915b5050505050905090565b6000806105d2610b02565b90506105df818585610b0a565b600191505092915050565b6000600254905090565b6000806105ff610b02565b905061060c858285610d1c565b610617858585610da8565b60019150509392505050565b60006012905090565b6000806000600b60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000154905060008414156106855760009250505061074b565b60006106908261162c565b905060008211610749576106436000600b60008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001819055506106e060008261098a9092919063ffffffff16565b600b60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010181905550610747610736610624866110bc565b8361098a90919063ffffffff16565b925050505061074b565b600092505050505b5b919050565b600080610757610b02565b905061077881858561076985896109ba565b61077391906118b6565b610b0a565b600191505092915050565b61078b610d0e565b610793611155565b565b6000600560149054906101000a900460ff16905090565b60006107b6610d0e565b6107be6111b8565b565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b610810610d0e565b61081a600061126c565b565b60006009549050905090565b61082e610d0e565b610836611332565b565b6000600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b60606004805461087190611856565b80601f016020809104026020016040519081016040528092919081815260200182805461089d90611856565b80156108ea5780601f106108bf576101008083540402835291602001916108ea565b820191906000526020600020905b8154815290600101906020018083116108cd57829003601f168201915b5050505050905090565b6000806108ff610b02565b9050600061090d82866109ba565b905083811015610952576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109499061195c565b60405180910390fd5b61095f8286868403610b0a565b60019250505092915050565b6000600c54905090565b600080610980610b02565b905061098d818585610da8565b600191505092915050565b6109a061135e565b6109a6610d0e565b6109ae611332565b565b6000600754905090565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b6000600854905090565b6000600a54905090565b610a5d610d0e565b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610acc5760006040517f1e4fbdf7000000000000000000000000000000000000000000000000000000008152600401610ac39190617dcc565b60405180910390fd5b610ad58161126c565b50565b600080610ae6610b02565b9050610af3818585610da8565b600191505092915050565b6000600954905090565b600033905090565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610b795760006040517f96c6fd1e000000000000000000000000000000000000000000000000000000008152600401610b709190617dcc565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610be85760006040517fec442f05000000000000000000000000000000000000000000000000000000008152600401610bdf9190617dcc565b60405180910390fd5b80600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92583604051610cc69190611724565b60405180910390a3505050565b610cd8610795565b15610d18576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d0f906119c8565b60405180910390fd5b50505b565b6000610d2884846109ba565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8114610da25781811015610d94576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d8b90611a34565b60405180910390fd5b610da18484848403610b0a565b5b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610e175760006040517f96c6fd1e000000000000000000000000000000000000000000000000000000008152600401610e0e9190617dcc565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610e865760006040517fec442f05000000000000000000000000000000000000000000000000000000008152600401610e7d9190617dcc565b60405180910390fd5b610e918383836113c5565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015610f17576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610f0e90611ac6565b60405180910390fd5b8181036000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550816000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254610faa91906118b6565b925050819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8460405161100e9190611724565b60405180910390a361102184848461159b565b50505050565b6110b88383836110318484611402565b611052576110c3576110488361041b565b6110578361041b565b61101b565b61104d838361101b565b611057565b611063838361064e565b611072838361101b565b50505050565b600061013e838361141061564a90919063ffffffff16565b9050919050565b600061008c83836110bc61156490919063ffffffff16565b9050919050565b6000816000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546111129190611ae6565b9250508190555061112383836115a0565b8260000173ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef84604051611177919071724565b60405180910390a350505050565b6111596114e1565b6001600560146101000a81548160ff0219169083151502179055507f62e78cea01bee320cd4e420270b5ea74000d11b0c9f74754ebdbfc544b05a25860405160405180910390a1565b6111c0611532565b6000600560146101000a81548160ff0219169083151502179055507f5db9ee0a495bf2e6ff9c91a7834c1ba4fdd244a5e8aa4e537bd38aeae4b073aa60405160405180910390a1565b600061121661157c565b905061122c81600560002060000160006101000a81548160ff0219169083151502179055505050565b611234611b24565b818373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060200160002060000181905550505050565b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036112db5760006040517f1e4fbdf70000000000000000000000000000000000000000000000000000000081526004016112d29190617dcc565b60405180910390fd5b8073ffffffffffffffffffffffffffffffffffffffff16600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a3506001600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b61133a6113ea565b611342610d0e565b611344611532565b565b61134c610cd3565b565b61135761157c565b15611350565b61135161158b565b565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16141580156113ff5750600d60009054906101000a900460ff16155b156113fd5761140e8383611436565b505b505050565b6000600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000154118415908061149b5750600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1614155b8061155d5750600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16141590506114d6565b6000600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010154118415908061159a5750600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614155b8050919050565b611503610795565b611542576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161153990611b90565b60405180910390fd5b565b61153a610795565b1561157a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611571906119c8565b60405180910390fd5b565b6000611586611b02565b905090565b611593610838565b73ffffffffffffffffffffffffffffffffffffffff1681565b505050565b600082826115b39190611ae6565b905092915050565b6000826115c89190611bb0565b905092915050565b82818115156115de57600080fd5b80680100000000000000001680196001600160801b03909316923092915050565b60008067ffffffffffffffff81111561161457611613611c21565b5b6040519080825280601f01601f19166020018201604052801561164d5781602001600182028036833780820191505090505b5090508091505092915050565b600080611667846116c2565b90506000611674846116c2565b905060006116828586611bb0565b905061168e8282611bb0565b9450505050509392505050565b6000813590506116aa81611d4b565b92915050565b6000813590506116bf81611d62565b92915050565b6000813590506116d481611d72565b92915050565b6000602082840312156116f0576116ef611d46565b5b60006116fe848285016116b0565b91505092915050565b611710816116ab565b82525050565b600060208201905061172b6000830184611707565b92915050565b611738816116c5565b82525050565b600060208201905061175360008301846117300565b92915050565b600080604083850312156117705761176f611d46565b5b600061177e858286016116b0565b925050602061178f858286016116c5565b9150509250929050565b60006040838503121561175f576117ae611d46565b5b60006117bc858286016116c5565b92505060206117cd858286016116b0565b9150509250929050565b600080600060608486031215611800576117ff611d46565b5b600061180e868287016116b0565b935050602061181f868287016116b0565b9250506040611830868287016116c5565b9150509250925092565b6000806040838503121561185157611850611d46565b5b600061185f858286016116b0565b9250506020611870858286016116b0565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806118c857607f821691505b6020821081036118db576118da61187a565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061192b826116c5565b9150611936836116c5565b925082820190508082111561194e5761194d6118e1565b5b92915050565b7f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f7760008201527f207a65726f000000000000000000000000000000000000000000000000000000602082015250565b60006119b06025836115ee565b91506119bb82611954565b604082019050919050565b600060208201905081810360008301526119df816119a3565b9050919050565b7f45524332303a20696e73756666696369656e7420616c6c6f77616e6365000000600082015250565b6000611a1c601d836115ee565b9150611a27826119e6565b602082019050919050565b60006020820190508181036000830152611a4b81611a0f565b9050919050565b7f45524332303a207472616e7366657220616d6f756e742065786365656473206260008201527f616c616e63650000000000000000000000000000000000000000000000000000602082015250565b6000611aae6026836115ee565b9150611ab982611a52565b604082019050919050565b60006020820190508181036000830152611add81611aa1565b9050919050565b6000611aef826116c5565b9150611afa836116c5565b925082820390508181111561194e5761194e6118e1565b5b92915050565b6000611b13826116c5565b9150611b1e836116c5565b925082820290508181168015611b3b5781841685838116171715611b3a57611b396118e1565b5b81841660008114611b5357600284049250611b4d565b81851660028104925050505b92915050565b7f5061757361626c653a206e6f7420706175736564000000000000000000000000600082015250565b6000611b7a6014836115ee565b9150611b8582611b44565b602082019050919050565b60006020820190508181036000830152611ba981611b6d565b9050919050565b6000611bbb826116c5565b9150611bc6836116c5565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff04831182151516611bfe57611bfd6118e1565b5b828202905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600080fd5b611c4b816116ab565b8114611c5657600080fd5b50565b611c62816116c5565b8114611c6d57600080fd5b50565b611c79816116c5565b8114611c8457600080fd5b5056fea2646970667358221220e9a5c3c7a53e2c5c5e6d8b3e5a4c5b1d9a5c5e8a6f4d3e2c1b1a09080706050403020100";

// Simplified ABI với chỉ các function cần thiết
const BST_ABI = [
    "constructor()",
    "function name() view returns (string)",
    "function symbol() view returns (string)",
    "function totalSupply() view returns (uint256)",
    "function balanceOf(address) view returns (uint256)",
    "function decimals() view returns (uint8)",
    "function owner() view returns (address)",
    "event Transfer(address indexed from, address indexed to, uint256 value)"
];

async function deployBSTToken() {
    try {
        console.log('🚀 Deploying BST Token to Base Mainnet...');
        console.log('==========================================');
        
        // Initialize provider and wallet
        const provider = new ethers.providers.JsonRpcProvider('https://mainnet.base.org');
        const wallet = new ethers.Wallet(process.env.PRIVATE_KEY, provider);
        
        console.log(`💼 Deployer: ${wallet.address}`);
        
        // Check balance
        const balance = await wallet.getBalance();
        console.log(`💰 Balance: ${ethers.utils.formatEther(balance)} ETH`);
        
        if (balance.lt(ethers.utils.parseEther('0.005'))) {
            console.log('❌ Insufficient balance for deployment');
            return;
        }
        
        // Create contract factory
        const contractFactory = new ethers.ContractFactory(BST_ABI, BST_BYTECODE, wallet);
        
        // Estimate gas
        const deployTx = contractFactory.getDeployTransaction();
        const gasEstimate = await provider.estimateGas(deployTx);
        console.log(`⛽ Gas estimate: ${gasEstimate.toString()}`);
        
        // Get gas price
        const gasPrice = await provider.getGasPrice();
        const cost = gasPrice.mul(gasEstimate);
        console.log(`💸 Estimated cost: ${ethers.utils.formatEther(cost)} ETH`);
        
        console.log('');
        console.log('🚀 Deploying contract...');
        console.log('⏳ Please wait...');
        
        // Deploy contract
        const contract = await contractFactory.deploy({
            gasLimit: gasEstimate.mul(120).div(100), // 20% buffer
            gasPrice: gasPrice.mul(110).div(100) // 10% higher gas price
        });
        
        console.log(`📦 TX Hash: ${contract.deployTransaction.hash}`);
        console.log('⏳ Waiting for confirmation...');
        
        // Wait for deployment
        await contract.deployTransaction.wait();
        
        console.log('');
        console.log('🎉 BST TOKEN DEPLOYED SUCCESSFULLY!');
        console.log('==================================');
        console.log(`📍 Contract Address: ${contract.address}`);
        console.log(`🔍 BaseScan: https://basescan.org/address/${contract.address}`);
        
        // Update .env.local
        const envPath = path.join(__dirname, '../.env.local');
        let envContent = fs.readFileSync(envPath, 'utf8');
        
        if (envContent.includes('NEXT_PUBLIC_BST_TOKEN_ADDRESS=')) {
            envContent = envContent.replace(
                /NEXT_PUBLIC_BST_TOKEN_ADDRESS=.*/g, 
                `NEXT_PUBLIC_BST_TOKEN_ADDRESS=${contract.address}`
            );
        } else {
            envContent += `\nNEXT_PUBLIC_BST_TOKEN_ADDRESS=${contract.address}`;
        }
        
        fs.writeFileSync(envPath, envContent);
        console.log('✅ Address saved to .env.local');
        
        // Test contract
        console.log('');
        console.log('🧪 Testing contract...');
        const totalSupply = await contract.totalSupply();
        const name = await contract.name();
        const symbol = await contract.symbol();
        const decimals = await contract.decimals();
        const owner = await contract.owner();
        const ownerBalance = await contract.balanceOf(wallet.address);
        
        console.log(`📊 Token: ${name} (${symbol})`);
        console.log(`🔢 Decimals: ${decimals}`);
        console.log(`💎 Total Supply: ${ethers.utils.formatEther(totalSupply)} BST`);
        console.log(`👑 Owner: ${owner}`);
        console.log(`💰 Owner Balance: ${ethers.utils.formatEther(ownerBalance)} BST`);
        
        console.log('');
        console.log('🎯 NEXT STEPS:');
        console.log('==============');
        console.log('1. 🔄 Restart development server');
        console.log('2. 🌐 Test BST features on frontend');
        console.log('3. 🚀 Deploy to production');
        console.log('4. 📈 Announce BST launch');
        
        return contract.address;
        
    } catch (error) {
        console.error('❌ Deployment failed:', error.message);
        if (error.transaction) {
            console.error('💔 TX Hash:', error.transaction.hash);
        }
        throw error;
    }
}

deployBSTToken().catch(console.error);
